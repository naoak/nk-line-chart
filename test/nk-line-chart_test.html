<!doctype html>

<html>
  <head>
    <title>nk-line-chart test</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <link rel="import" href="../nk-line-chart.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <style>
          nk-line-chart {
            width: 200px;
            height: 100px;
          }
        </style>
        <nk-line-chart></nk-line-chart>
      </template>
    </test-fixture>

    <script>
      describe('nk-line-chart', function() {
        var chart;
        var sandbox;

        beforeEach(function() {
          sandbox = sinon.sandbox.create();
          chart = fixture('basic')[1];
        });

        it('SVG tag will be created if rows and chartAreas are set', function(done) {
          var container = chart.$.container;
          var appendChild = sandbox.spy(container, 'appendChild');

          chart.rows = [
            [0, 0], [1, 1]
          ];
          chart.chartArea = {
            width: 200,
            height: 100
          };
          expect(appendChild).not.to.be.called;
          chart.async(function() {
            expect(appendChild).to.be.calledOnce;
            expect(container.children.length).to.equal(1);
            expect(container.children[0].tagName).to.equal('svg');
            done();
          });
        });

        it('SVG tags never exist more than one', function(done) {
          var container = chart.$.container;
          var appendChild = sandbox.spy(container, 'appendChild');
          var removeChild = sandbox.spy(container, 'removeChild');

          chart.rows = [
            [0, 0], [1, 1]
          ];
          chart.chartArea = {
            width: 200,
            height: 100
          };
          expect(appendChild).not.to.be.called;
          chart.async(function() {
            expect(appendChild).to.be.calledOnce;
            expect(removeChild).not.to.be.called;
            expect(container.children.length).to.equal(1);
            expect(container.children[0].tagName).to.equal('svg');
            chart.chartArea = {
              width: 100,
              height: 100
            };
            chart.async(function() {
              expect(appendChild).to.be.calledTwice;
              expect(removeChild).to.be.calledOnce;
              expect(container.children.length).to.equal(1);
              expect(container.children[0].tagName).to.equal('svg');
              done();
            });
          });
        });

        it('SVG tag will not be created if rows or chartArea is null', function(done) {
          var container = chart.$.container;
          var appendChild = sandbox.spy(container, 'appendChild');
          var removeChild = sandbox.spy(container, 'removeChild');

          chart.rows = [
            [0, 0], [1, 1]
          ];
          chart.chartArea = {
            width: 200,
            height: 100
          };
          expect(appendChild).not.to.be.called;
          chart.async(function() {
            expect(appendChild).to.be.calledOnce;
            expect(removeChild).not.to.be.called;
            expect(container.children.length).to.equal(1);
            expect(container.children[0].tagName).to.equal('svg');
            chart.chartArea = null;
            chart.async(function() {
              expect(appendChild).to.be.calledOnce;
              expect(removeChild).to.be.calledOnce;
              expect(container.children.length).to.equal(0);
              chart.rows = null;
              chart.chartArea = {
                width: 200,
                height: 100
              };
              chart.async(function() {
                expect(appendChild).to.be.calledOnce;
                expect(removeChild).to.be.calledOnce;
                expect(container.children.length).to.equal(0);
                done();
              });
            });
          });
        });

        it('Automatic Axis Range: Points just fit in the chart area when top and left are not specified', function(done) {
          var container = chart.$.container;

          chart.rows = [
            [0, 0], [1, 1], [2, 2]
          ];
          chart.chartArea = {
            width: 200,
            height: 100
          };
          chart.origin = 'left-top';
          chart.async(function() {
            var svg = container.children[0];
            var circles = Polymer.dom(svg).querySelectorAll('circle');
            expect(circles.length).to.equal(3);
            var c0 = circles[0];
            expect(c0.getAttribute('cx')).to.equal('0');
            expect(c0.getAttribute('cy')).to.equal('0');
            var c1 = circles[1];
            expect(c1.getAttribute('cx')).to.equal('100');
            expect(c1.getAttribute('cy')).to.equal('50');
            var c2 = circles[2];
            expect(c2.getAttribute('cx')).to.equal('200');
            expect(c2.getAttribute('cy')).to.equal('100');
            done();
          });
        });

        it('Automatic Axis Range: Points just fit in the chart area when the minimums of x and y are not 0', function(done) {
          var container = chart.$.container;

          chart.rows = [
            [-1, -1], [0, 0], [1, 1]
          ];
          chart.chartArea = {
            width: 200,
            height: 100
          };
          chart.origin = 'left-top';
          chart.async(function() {
            var svg = container.children[0];
            var circles = Polymer.dom(svg).querySelectorAll('circle');
            expect(circles.length).to.equal(3);
            var c0 = circles[0];
            expect(c0.getAttribute('cx')).to.equal('0');
            expect(c0.getAttribute('cy')).to.equal('0');
            var c1 = circles[1];
            expect(c1.getAttribute('cx')).to.equal('100');
            expect(c1.getAttribute('cy')).to.equal('50');
            var c2 = circles[2];
            expect(c2.getAttribute('cx')).to.equal('200');
            expect(c2.getAttribute('cy')).to.equal('100');
            done();
          });
        });

        it('Automatic Axis Range: Points just fit in the chart area when top and left are 0', function(done) {
          var container = chart.$.container;

          chart.rows = [
            [0, 0], [1, 1], [2, 2]
          ];
          chart.chartArea = {
            top: 0,
            left: 0,
            width: 200,
            height: 100
          };
          chart.origin = 'left-top';
          chart.async(function() {
            var svg = container.children[0];
            var circles = Polymer.dom(svg).querySelectorAll('circle');
            expect(circles.length).to.equal(3);
            var c0 = circles[0];
            expect(c0.getAttribute('cx')).to.equal('0');
            expect(c0.getAttribute('cy')).to.equal('0');
            var c1 = circles[1];
            expect(c1.getAttribute('cx')).to.equal('100');
            expect(c1.getAttribute('cy')).to.equal('50');
            var c2 = circles[2];
            expect(c2.getAttribute('cx')).to.equal('200');
            expect(c2.getAttribute('cy')).to.equal('100');
            done();
          });
        });

        it('Automatic Axis Range: Points just fit in the chart area even when top and left are not 0', function(done) {
          var container = chart.$.container;

          chart.rows = [
            [0, 0], [1, 1], [2, 2]
          ];
          chart.chartArea = {
            top: 10,
            left: 10,
            width: 180,
            height: 80
          };
          chart.origin = 'left-top';
          chart.async(function() {
            var svg = container.children[0];
            var circles = Polymer.dom(svg).querySelectorAll('circle');
            expect(circles.length).to.equal(3);
            var c0 = circles[0];
            expect(c0.getAttribute('cx')).to.equal('10');
            expect(c0.getAttribute('cy')).to.equal('10');
            var c1 = circles[1];
            expect(c1.getAttribute('cx')).to.equal('100');
            expect(c1.getAttribute('cy')).to.equal('50');
            var c2 = circles[2];
            expect(c2.getAttribute('cx')).to.equal('190');
            expect(c2.getAttribute('cy')).to.equal('90');
            done();
          });
        });

        it('X-axis range can be explicitly set', function(done) {
          var container = chart.$.container;

          chart.rows = [
            [0, 0], [1, 1], [2, 2]
          ];
          chart.chartArea = {
            top: 0,
            left: 0,
            width: 200,
            height: 100
          };
          chart.origin = 'left-top';
          chart.xRange = {
            min: -1,
            max: 4
          };
          chart.async(function() {
            var svg = container.children[0];
            var circles = Polymer.dom(svg).querySelectorAll('circle');
            expect(circles.length).to.equal(3);
            var c0 = circles[0];
            expect(c0.getAttribute('cx')).to.equal('40');
            expect(c0.getAttribute('cy')).to.equal('0');
            var c1 = circles[1];
            expect(c1.getAttribute('cx')).to.equal('80');
            expect(c1.getAttribute('cy')).to.equal('50');
            var c2 = circles[2];
            expect(c2.getAttribute('cx')).to.equal('120');
            expect(c2.getAttribute('cy')).to.equal('100');
            done();
          });
        });

        it('Y-axis range can be explicitly set', function(done) {
          var container = chart.$.container;

          chart.rows = [
            [0, 0], [1, 1], [2, 2]
          ];
          chart.chartArea = {
            top: 0,
            left: 0,
            width: 200,
            height: 100
          };
          chart.origin = 'left-top';
          chart.yRange = {
            min: -1,
            max: 4
          };
          chart.async(function() {
            var svg = container.children[0];
            var circles = Polymer.dom(svg).querySelectorAll('circle');
            expect(circles.length).to.equal(3);
            var c0 = circles[0];
            expect(c0.getAttribute('cx')).to.equal('0');
            expect(c0.getAttribute('cy')).to.equal('20');
            var c1 = circles[1];
            expect(c1.getAttribute('cx')).to.equal('100');
            expect(c1.getAttribute('cy')).to.equal('40');
            var c2 = circles[2];
            expect(c2.getAttribute('cx')).to.equal('200');
            expect(c2.getAttribute('cy')).to.equal('60');
            done();
          });
        });

        it('The length of rows can be 0', function(done) {
          var container = chart.$.container;

          chart.rows = [];
          chart.chartArea = {
            width: 200,
            height: 100
          };
          chart.async(function() {
            var svg = container.children[0];
            expect(svg.tagName).to.equal('svg');
            var circles = Polymer.dom(svg).querySelectorAll('circle');
            expect(circles.length).to.equal(0);
            done();
          });
        });

        it('A point will be located in the center when the lengh of rows is 1', function(done) {
          var container = chart.$.container;

          chart.rows = [
            [0, 0]
          ];
          chart.chartArea = {
            width: 200,
            height: 100
          };
          chart.async(function() {
            var svg = container.children[0];
            expect(svg.tagName).to.equal('svg');
            var circles = Polymer.dom(svg).querySelectorAll('circle');
            expect(circles.length).to.equal(1);
            var c0 = circles[0];
            expect(c0.getAttribute('cx')).to.equal('100');
            expect(c0.getAttribute('cy')).to.equal('50');
            done();
          });
        });

        it('The change of origin invokes the recalculation of transform', function(done) {
          var container = chart.$.container;

          chart.rows = [
            ['0', '0'], ['1', '1']
          ];
          chart.chartArea = {
            top: 10,
            left: 10,
            width: 180,
            height: 80
          };
          expect(chart.origin).to.equal('left-bottom');
          chart.async(function() {
            var circles = getCircles(container);
            var c0 = circles[0];
            var c1 = circles[1];
            expect(c0.getAttribute('cx')).to.equal('10');
            expect(c0.getAttribute('cy')).to.equal('90');
            expect(c1.getAttribute('cx')).to.equal('190');
            expect(c1.getAttribute('cy')).to.equal('10');
            chart.origin = 'left-top';
            chart.async(function() {
              var circles = getCircles(container);
              var c0 = circles[0];
              var c1 = circles[1];
              expect(c0.getAttribute('cx')).to.equal('10');
              expect(c0.getAttribute('cy')).to.equal('10');
              expect(c1.getAttribute('cx')).to.equal('190');
              expect(c1.getAttribute('cy')).to.equal('90');
              chart.origin = 'right-top';
              chart.async(function() {
                var circles = getCircles(container);
                var c0 = circles[0];
                var c1 = circles[1];
                expect(c0.getAttribute('cx')).to.equal('190');
                expect(c0.getAttribute('cy')).to.equal('10');
                expect(c1.getAttribute('cx')).to.equal('10');
                expect(c1.getAttribute('cy')).to.equal('90');
                chart.origin = 'right-bottom';
                chart.async(function() {
                  var circles = getCircles(container);
                  var c0 = circles[0];
                  var c1 = circles[1];
                  expect(c0.getAttribute('cx')).to.equal('190');
                  expect(c0.getAttribute('cy')).to.equal('90');
                  expect(c1.getAttribute('cx')).to.equal('10');
                  expect(c1.getAttribute('cy')).to.equal('10');
                  chart.origin = '';
                  chart.async(function() {
                    var circles = getCircles(container);
                    var c0 = circles[0];
                    var c1 = circles[1];
                    expect(c0.getAttribute('cx')).to.equal('10');
                    expect(c0.getAttribute('cy')).to.equal('10');
                    expect(c1.getAttribute('cx')).to.equal('190');
                    expect(c1.getAttribute('cy')).to.equal('90');
                    done();
                  });
                });
              });
            });
          });

          function getCircles(container) {
            var svg = container.children[0];
            expect(svg.tagName).to.equal('svg');
            var circles = Polymer.dom(svg).querySelectorAll('circle');
            expect(circles.length).to.equal(2);
            return circles;
          }
        });

        it('The style of the background can be changed', function(done) {
          var container = chart.$.container;

          chart.rows = [
            [0, 0], [1, 1]
          ];
          chart.chartArea = {
            top: 10,
            left: 10,
            width: 180,
            height: 80
          };
          chart.backgroundRectStyle = {
            fill: "#00f",
            fillOpacity: 0.1,
            stroke: "#00f",
            strokeOpacity: 0.3,
            strokeWidth: 5
          };
          chart.async(function() {
            var svg = container.children[0];
            var rect = Polymer.dom(svg).querySelector('rect');
            expect(rect.getAttribute('fill')).to.equal('#00f');
            expect(rect.getAttribute('fill-opacity')).to.equal('0.1');
            expect(rect.getAttribute('stroke')).to.equal('#00f');
            expect(rect.getAttribute('stroke-opacity')).to.equal('0.3');
            expect(rect.getAttribute('stroke-width')).to.equal('5');
            done();
          });
        });

        it('The style of points can be changed by point.elements (Array)', function(done) {
          var container = chart.$.container;

          chart.rows = [
            [0, 0], [1, 1]
          ];
          chart.chartArea = {
            top: 10,
            left: 10,
            width: 180,
            height: 80
          };
          chart.point = {
            enable: true,
            elements: [
              {
                type: 'circle',
                style: {
                  fill: '#fff',
                  r: '6',
                  stroke: '#e88',
                  strokeWidth: 1.5
                }
              },
              {
                type: 'circle',
                style: {
                  fill: '#e88',
                  r: '3',
                  stroke: 'none',
                  strokeWidth: 0
                }
              }
            ]
          };
          chart.async(function() {
            var svg = container.children[0];
            var points = Polymer.dom(svg).querySelectorAll('.nk-line-chart-point');
            expect(points.length).to.equal(2);
            points.forEach(function(p) {
              var circles = Polymer.dom(p).querySelectorAll('circle');
              expect(circles.length).to.equal(2);
              var c0 = circles[0];
              var c1 = circles[1];
              expect(c0.getAttribute('fill')).to.equal('#fff');
              expect(c0.getAttribute('r')).to.equal('6');
              expect(c0.getAttribute('stroke')).to.equal('#e88');
              expect(c0.getAttribute('stroke-width')).to.equal('1.5');
              expect(c1.getAttribute('fill')).to.equal('#e88');
              expect(c1.getAttribute('r')).to.equal('3');
              expect(c1.getAttribute('stroke')).to.equal('none');
              expect(c1.getAttribute('stroke-width')).to.equal('0');
            });
            done();
          });
        });

        it('The style of points can be changed by point.elements (Function)', function(done) {
          var container = chart.$.container;

          chart.rows = [
            [0, 0], [1, 1]
          ];
          chart.chartArea = {
            top: 10,
            left: 10,
            width: 180,
            height: 80
          };
          chart.point = {
            enable: true,
            elements: function(p, i) {
              if (i === 0) {
                return [{
                  type: 'circle',
                  style: {
                    fill: '#f00',
                    r: '3',
                    stroke: 'none',
                    strokeWidth: 0
                  }
                }];
              }
              else {
                return [{
                  type: 'circle',
                  style: {
                    fill: '#00f',
                    r: '3',
                    stroke: 'none',
                    strokeWidth: 0
                  }
                }];
              }
            }
          };
          chart.async(function() {
            var svg = container.children[0];
            var points = Polymer.dom(svg).querySelectorAll('.nk-line-chart-point');
            expect(points.length).to.equal(2);
            points.forEach(function(p, i) {
              var circles = Polymer.dom(p).querySelectorAll('circle');
              expect(circles.length).to.equal(1);
              var c0 = circles[0];
              expect(c0.getAttribute('fill')).to.equal(i === 0 ? '#f00' : '#00f');
              expect(c0.getAttribute('r')).to.equal('3');
              expect(c0.getAttribute('stroke')).to.equal('none');
              expect(c0.getAttribute('stroke-width')).to.equal('0');
            });
            done();
          });
        });

        it('The style of a polygonal line can be changed', function(done) {
          var container = chart.$.container;

          chart.rows = [
            [0, 0], [1, 1]
          ];
          chart.chartArea = {
            top: 10,
            left: 10,
            width: 180,
            height: 80
          };
          chart.pathStyle = {
            fill: 'none',
            fillOpacity: '1',
            stroke: '#0f0',
            strokeWidth: '5'
          };
          chart.async(function() {
            var svg = container.children[0];
            var path = Polymer.dom(svg).querySelector('path');
            expect(path.getAttribute('fill')).to.equal('none');
            expect(path.getAttribute('fill-opacity')).to.equal('1');
            expect(path.getAttribute('stroke')).to.equal('#0f0');
            expect(path.getAttribute('stroke-width')).to.equal('5');
            done();
          });
        });

        it('The label at point can be enabled', function(done) {
          var container = chart.$.container;

          chart.rows = [
            [1, 2], [3, 4]
          ];
          chart.chartArea = {
            top: 10,
            left: 10,
            width: 180,
            height: 80
          };
          chart.pointLabel.enable = true;
          chart.async(function() {
            var svg = container.children[0];
            var texts = Polymer.dom(svg).querySelectorAll('text');
            expect(texts.length).to.equal(2);
            expect(texts[0].textContent).to.equal('[1,2]');
            expect(texts[1].textContent).to.equal('[3,4]');
            done();
          });
        });

        it('The offset of label at point can be changed', function(done) {
          var container = chart.$.container;

          chart.rows = [
            [1, 2], [3, 4]
          ];
          chart.chartArea = {
            top: 10,
            left: 10,
            width: 180,
            height: 80
          };
          chart.origin = 'left-bottom';
          chart.pointLabel.enable = true;
          chart.pointLabel.offset = {
            x: 1,
            y: 1
          };
          chart.async(function() {
            var svg = container.children[0];
            var texts = Polymer.dom(svg).querySelectorAll('text');
            expect(texts.length).to.equal(2);
            expect(texts[0].getAttribute('x')).to.equal('11');
            expect(texts[0].getAttribute('y')).to.equal('91');
            expect(texts[1].getAttribute('x')).to.equal('191');
            expect(texts[1].getAttribute('y')).to.equal('11');
            done();
          });
        });

        it('The text formater of label at point can be changed', function(done) {
          var container = chart.$.container;

          chart.rows = [
            [1, 2], [3, 4]
          ];
          chart.chartArea = {
            top: 10,
            left: 10,
            width: 180,
            height: 80
          };
          chart.pointLabel.enable = true;
          chart.pointLabel.textFormat = function(row, index) {
            return '[' + index + ',' + row + ']';
          };
          chart.async(function() {
            var svg = container.children[0];
            var texts = Polymer.dom(svg).querySelectorAll('text');
            expect(texts.length).to.equal(2);
            expect(texts[0].textContent).to.equal('[0,1,2]');
            expect(texts[1].textContent).to.equal('[1,3,4]');
            done();
          });
        });

        it('The text style of label at point can be changed', function(done) {
          var container = chart.$.container;

          chart.rows = [
            [1, 2], [3, 4]
          ];
          chart.chartArea = {
            top: 10,
            left: 10,
            width: 180,
            height: 80
          };
          chart.pointLabel.enable = true;
          chart.pointLabel.textStyle = {
            fill: 'blue'
          };
          chart.async(function() {
            var svg = container.children[0];
            var pointLabelGroup = Polymer.dom(svg).querySelector('.nk-line-chart-point-label-group');
            var texts = Polymer.dom(pointLabelGroup).querySelectorAll('.nk-line-chart-point-label');
            expect(texts.length).to.equal(2);
            expect(texts[0].getAttribute('fill')).to.equal('blue');
            expect(texts[1].getAttribute('fill')).to.equal('blue');
            done();
          });
        });
      });
    </script>
  </body>
</html>
